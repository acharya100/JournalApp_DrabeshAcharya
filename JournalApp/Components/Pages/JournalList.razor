@page "/journal/list"
@using JournalApp.Models
@inject IAuthService AuthService
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject ILogger<JournalList> Logger
@attribute [Authorize]

<div class="journal-list-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>All Entries</h2>
        <a href="/journal/new" class="btn btn-primary">New Entry</a>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (entries.Any())
    {
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span>Page @currentPage of @totalPages</span>
                    <span class="ms-3">Total: @totalEntries entries</span>
                </div>
                <div class="pagination-select-wrapper">
                    <select class="form-select form-select-sm pagination-select" @bind="pageSize" @bind:after="HandlePageSizeChange">
                        <option value="10">10 per page</option>
                        <option value="20">20 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="list-group">
            @foreach (var entry in entries)
            {
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="mb-1">
                                <a href="/journal/edit/@entry.EntryId" class="text-decoration-none">
                                    @entry.JournalTitle
                                </a>
                            </h5>
                            <p class="mb-1 text-muted">
                                <small>@entry.EntryDate.ToString("MMMM dd, yyyy")</small>
                            </p>
                            <p class="mb-1">
                                @if (entry.Content.Length > 200)
                                {
                                    @(entry.Content.Substring(0, 200) + "...")
                                }
                                else
                                {
                                    @entry.Content
                                }
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-primary me-1">@entry.PrimaryMood?.MoodName</span>
                                @if (entry.SecondaryMoods != null && entry.SecondaryMoods.Any())
                                {
                                    @foreach (var sm in entry.SecondaryMoods)
                                    {
                                        <span class="badge bg-secondary me-1">@sm.Mood?.MoodName</span>
                                    }
                                }
                                @if (entry.Tags != null && entry.Tags.Any())
                                {
                                    @foreach (var tag in entry.Tags)
                                    {
                                        <span class="badge bg-info me-1">@tag.Tag?.TagName</span>
                                    }
                                }
                            </div>
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-danger" @onclick="() => HandleDelete(entry.EntryId)">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
                </li>
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    var pageNum = i;
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(pageNum)">@i</button>
                    </li>
                }
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
                </li>
            </ul>
        </nav>
    }
    else
    {
        <div class="alert alert-info">
            <h4>No entries found</h4>
            <p>Start your journaling journey by creating your first entry!</p>
            <a href="/journal/new" class="btn btn-primary">Create First Entry</a>
        </div>
    }
</div>

@code {
    private List<JournalEntry> entries = new();
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalEntries = 0;
    private int totalPages = 0;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated || !AuthService.CurrentUserId.HasValue)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        try
        {
            isLoading = true;
            totalEntries = await JournalService.GetTotalEntriesCountAsync(AuthService.CurrentUserId!.Value);
            totalPages = (int)Math.Ceiling(totalEntries / (double)pageSize);
            
            entries = await JournalService.GetEntriesAsync(AuthService.CurrentUserId.Value, currentPage, pageSize);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading journal entries");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadEntries();
        }
    }

    private async Task HandlePageSizeChange()
    {
        currentPage = 1;
        await LoadEntries();
    }

    private async Task HandleDelete(int entryId)
    {
        if (!await ConfirmDelete())
            return;

        try
        {
            var success = await JournalService.DeleteEntryAsync(entryId);
            if (success)
            {
                await LoadEntries();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting entry");
        }
    }

    private Task<bool> ConfirmDelete()
    {
        // In a real app, use a proper confirmation dialog
        return Task.FromResult(true); // Simplified for now
    }
}

<style>
    .pagination-select-wrapper {
        position: relative;
    }

    .pagination-select {
        border-radius: 20px;
        border: 1px solid var(--bs-border-color);
        padding: 0.375rem 2rem 0.375rem 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 10px 8px;
        -webkit-appearance: none;
        appearance: none;
    }

    .pagination-select:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 4px 8px rgba(var(--bs-primary-rgb), 0.15);
        transform: translateY(-1px);
    }

    .pagination-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
    }

    /* Dark mode adjustments */
    [data-bs-theme="dark"] .pagination-select {
        background-color: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }

    [data-bs-theme="dark"] .pagination-select:hover {
        border-color: #6ea8fe;
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }
</style>
